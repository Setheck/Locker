/*! Locker 15-12-2014 */
function Locker(){var a=this,b=!1,c="utf-8",d=".lock",e=1e4,f={autoRunning:null,drift:15e3,autoUpdateProcess:null,UUID:null,FILENAME:null};this.setDrift=function(a){return"number"==typeof a?(f.drift=a,!0):!1},this.unLock=function(b,d){if(b=i(b),d=j(d),a.stopAutoUpdate(),fs.existsSync(d)){var e=fs.readFileSync(d,c),g=JSON.parse(e);return(g.uuid==b||g.updated+f.drift<h())&&fs.unlinkSync(d),!0}return!1},this.getLock=function(a,b){if(a=i(a),b=j(b),!fs.existsSync(b)){var d={uuid:a,updated:h()};return fs.writeFileSync(b,JSON.stringify(d),c),!0}return!1},this.updateLock=function(b,d){if(b=i(b),d=j(d),a.getLock(b,d))return!0;var e=fs.readFileSync(d,c),g=JSON.parse(e);return g.uuid==b||g.updated+f.drift<h()?(g.updated=h(),fs.writeFileSync(d,JSON.stringify(g),c),!0):!1},this.hasLock=function(a,b){a=i(a),b=j(b);var d=fs.readFileSync(b,c),e=JSON.parse(d);return e.uuid==a||e.updated+f.drift<h()},this.startAutoUpdate=function(a,b,c){b=i(b),c=j(c),a&&"number"==typeof a||(a=e),f.autoRunning=!0,g(a,b,c)},this.stopAutoUpdate=function(){f.autoRunning=!1,f.autoUpdateProcess&&clearInterval(f.autoUpdateProcess)},this.debug=function(a){a&&(b=a)};var g=function(b,c,d){c=i(c),d=j(d),f.autoRunning&&(a.updateLock(c,d)?f.autoUpdateProcess=setTimeout(function(){g(b,c,d)},b):f.autoRunning=!1)},h=function(){return(new Date).getTime()},i=function(a){return f.UUID?f.UUID:a?a:(f.UUID=uuid.v1(),f.UUID)},j=function(a){return f.FILENAME?f.FILENAME:a?a:(f.FILENAME=d,f.FILENAME)}}var fs=require("fs"),uuid=require("uuid");module.exports=exports=new Locker;